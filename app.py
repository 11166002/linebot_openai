@app.route("/callback", methods=["POST"])
def callback():
    body = request.get_json()
    events = body.get("events", [])

    for event in events:
        if event["type"] == "message":
            reply_token = event["replyToken"]
            user_id = event["source"]["userId"]
            text = event["message"]["text"].strip()

            if text == "ä¸»é¸å–®":
                menu = (
                    "è«‹é¸æ“‡ï¼š\n"
                    "1. æˆ‘è¦çœ‹äº”åéŸ³\n"
                    "2. æˆ‘è¦ç©è¿·å®®éŠæˆ²\n"
                    "3. æˆ‘è¦ç©è³½è»ŠéŠæˆ²\n\n"
                    "ã€éŠæˆ²è¦å‰‡ã€‘\n"
                    "ğŸ“˜ çœ‹äº”åéŸ³ï¼šæŸ¥çœ‹æ‰€æœ‰å¹³å‡åã€ç‰‡å‡åèˆ‡ç¾…é¦¬æ‹¼éŸ³å°ç…§ã€‚\n"
                    "ğŸ§© è¿·å®®éŠæˆ²ï¼šä½¿ç”¨ã€ä¸Š/ä¸‹/å·¦/å³ã€ç§»å‹•è§’è‰²ï¼Œé‡åˆ°å‡åé¸æ“‡é¡Œæ™‚ç­”å°æ‰èƒ½ç¹¼çºŒã€‚\n"
                    "ğŸ è³½è»ŠéŠæˆ²ï¼šæ¯æ¬¡è¼¸å…¥ã€å‰é€²ã€æœƒæ¨é€²ä¸€æ ¼ï¼ŒæŠµé”çµ‚é»å³å‹åˆ©ï¼"
                )
                reply_text(reply_token, menu)

            elif text == "1" or text == "æˆ‘è¦çœ‹äº”åéŸ³":
                reply_text(reply_token, get_kana_table())

            elif text == "2" or text == "æˆ‘è¦ç©è¿·å®®éŠæˆ²":
                players[user_id] = {"pos": (1, 1), "quiz": None, "game": "maze"}
                reply_text(reply_token, render_map((1, 1)) + "\nğŸŒŸ è¿·å®®éŠæˆ²é–‹å§‹ï¼è«‹è¼¸å…¥ã€Œä¸Šã€ã€Œä¸‹ã€ã€Œå·¦ã€ã€Œå³ã€ç§»å‹•ã€‚")

            elif text == "3" or text == "æˆ‘è¦ç©è³½è»ŠéŠæˆ²":
                players[user_id] = {"car_pos": 0, "game": "race", "quiz": None, "last_quiz": None, "last_msg": None}
                reply_text(reply_token, render_race(0) + "\nğŸ è³½è»ŠéŠæˆ²é–‹å§‹ï¼è«‹è¼¸å…¥ã€Œå‰é€²ã€ä¾†æ¨é€²ä½ çš„è»Šå­ã€‚")

            elif user_id in players and players[user_id].get("game") == "maze" and text in ["ä¸Š", "ä¸‹", "å·¦", "å³"]:
                result = maze_game(user_id, text)
                reply_text(reply_token, result["map"] + "\nğŸ’¬ " + result["message"])

            elif user_id in players and players[user_id].get("game") == "maze" and players[user_id].get("quiz"):
                result = maze_game(user_id, text)
                reply_text(reply_token, result["map"] + "\nğŸ’¬ " + result["message"])

            elif user_id in players and players[user_id].get("game") == "race" and text == "å‰é€²":
                players[user_id]["last_msg"] = "A"  # æš«æ™‚å›ºå®šç‚º Aï¼Œå¯ä¹‹å¾Œæ”¹æˆç”¨æˆ¶è¼¸å…¥
                result = race_game(user_id)
                reply_text(reply_token, result)

            else:
                reply_text(reply_token,
                    "ğŸ“¢ è«‹è¼¸å…¥ä»¥ä¸‹æŒ‡ä»¤ä¹‹ä¸€ï¼š\n"
                    "1ï¸âƒ£ ã€ä¸»é¸å–®ã€ï¼šé–‹å•ŸåŠŸèƒ½é¸å–®\n"
                    "ğŸ”¼ ã€ä¸Š / ä¸‹ / å·¦ / å³ã€ï¼šç§»å‹•è§’è‰²ï¼ˆè¿·å®®ï¼‰\n"
                    "ğŸ ã€å‰é€²ã€ï¼šæ¨é€²è³½è»ŠéŠæˆ²")
    
def reply_text(reply_token, text):
    headers = {
        "Authorization": f"Bearer {CHANNEL_ACCESS_TOKEN}",
        "Content-Type": "application/json"
    }
    body = {
        "replyToken": reply_token,
        "messages": [{"type": "text", "text": text}]
    }
    requests.post("https://api.line.me/v2/bot/message/reply", headers=headers, json=body)

